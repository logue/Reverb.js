/**
 * @logue/reverb
 *
 * @description JavaScript Reverb effect class
 * @author Logue <logue@hotmail.co.jp>
 * @copyright 2019-2025 By Masashi Yoshikawa All rights reserved.
 * @license MIT
 * @version 1.3.17
 * @see {@link https://github.com/logue/Reverb.js}
 */

import{R as k}from"./Reverb-BW_4VY4L.js";const o=new AudioContext;document.addEventListener("touchstart",x);function x(){document.removeEventListener("touchstart",x);const e=o.createBufferSource();e.start(),e.stop()}const c=new Audio,p=o.createMediaElementSource(c),h=o.createAnalyser(),r=new k(o),S=async e=>{c&&(c.pause(),c.src=""),c.src=await P(e)},P=async e=>(document.getElementById("play").disabled="disabled",document.getElementById("stop").disabled="disabled",await new Promise(t=>{if(e instanceof File){const a=new FileReader;a.onload=d=>{t(d.target.result),document.getElementById("play").disabled="",document.getElementById("stop").disabled=""},a.readAsDataURL(e)}else fetch(e).then(a=>({mime:a.headers.get("content-type"),buffer:a.arrayBuffer()})).then(a=>{let d="";[].slice.call(new Uint8Array(a.buffer)).forEach(C=>d+=String.fromCharCode(C));const H=window.btoa(d);t("data:"+a.mime+";base64;"+H),document.getElementById("play").disabled="",document.getElementById("stop").disabled=""})}).catch(t=>alert(t))),B=async e=>{const t=e.target.files[0];p.buffer=await S(t)},b=()=>{p.disconnect(),document.getElementById("reverb").checked?r.connect(p).connect(h):r.disconnect(p).connect(h),h.connect(o.destination)},D=()=>{const e=document.createElement("canvas").getContext("2d"),t=window.devicePixelRatio||1,a=e.webkitBackingStorePixelRatio||e.mozBackingStorePixelRatio||e.msBackingStorePixelRatio||e.oBackingStorePixelRatio||e.backingStorePixelRatio||1;return t/a},M=(e,t,a)=>{a||(a=D);const d=document.getElementById("canvas");return d.width=e*a,d.height=t*a,d.style.width=e+"px",d.style.height=t+"px",d.getContext("2d").setTransform(a,0,0,a,0,0),d},s=256,g=512,l=M(g,s),F=()=>{const e=new Float32Array(1024);h.getFloatFrequencyData(e);const t=l.getContext("2d",{antialias:!1});t.clearRect(0,0,l.width,l.height);const a=t.createLinearGradient(0,0,l.width,0);a.addColorStop(0,"rgb(255, 0, 0)"),a.addColorStop(.2,"rgb(255, 255, 0)"),a.addColorStop(.4,"rgb(0, 255, 0)"),a.addColorStop(.6,"rgb(0, 255, 255)"),a.addColorStop(.8,"rgb(0, 0, 255)"),a.addColorStop(1,"rgb(255, 0, 255)"),t.fillStyle=a;for(let d=0;d<l.width;++d){o.sampleRate*d/1024;let w=128+(e[d]+48.16)*2.56+1;t.fillRect(d,l.height-w,1,w)}return l.toDataURL()},q=()=>{const e=l.getContext("2d",{antialias:!1});for(let t=-50;t<50;t+=10){const a=s/2-t*s/100|0;e.fillStyle="#6c757d",e.fillRect(20,a,g,1),e.fillStyle="#fd7e14",e.fillText(t+"dB",5,a)}e.fillStyle="#ffc107",e.fillRect(20,s/2,g,1);for(let t=2e3;t<o.sampleRate/2;t+=2e3){const a=t*1024/o.sampleRate|0;e.fillStyle="#6c757d",e.fillRect(a,0,1,245),e.fillStyle="#e83e8c",e.fillText(t/1e3+"kHz",a-10,255)}return l.toDataURL()},G=e=>{const t=document.getElementById("canvas");t.style.width=g+"px",t.style.height=s+"px",t.width=g,t.height=s;const a=document.getElementById("test");a.style.width=g+"px",a.style.height=s+"px",a.src=e;const d=new Image;d.addEventListener("load",()=>t.getContext("2d").drawImage(d,0,0)),d.src=e},L=960,T=540,R=new THREE.WebGLRenderer({canvas:document.querySelector("#graph")});R.setPixelRatio(window.devicePixelRatio);R.setSize(L,T);const u=new THREE.Scene,m=new THREE.PerspectiveCamera(30,L/T,1,2e3);m.position.set(100,50,1e3);u.fog=new THREE.Fog(0,1e3,2e3);const I=new THREE.Mesh(new THREE.PlaneGeometry(g,s,5,5),new THREE.MeshBasicMaterial({transparent:!0,needsUpdate:!0,map:new THREE.TextureLoader().load(q()),side:THREE.DoubleSide}));I.position.set(0,0,0);u.add(I);let n=0,E=[],y=[],v=[],f=[];const i=1024,A=()=>{const e=F();G(e),v[n]=new THREE.TextureLoader().load(e),E[n]=new THREE.PlaneGeometry(g,s,5,5),y[n]=new THREE.MeshBasicMaterial({color:13426158,transparent:!0,needsUpdate:!0,map:v[n],side:THREE.DoubleSide}),f[n]=new THREE.Mesh(E[n],y[n]),f[n].position.set(0,0,n),I.position.set(0,0,n),u.add(f[n]),R.render(u,m),m.position.z=n+650,m.updateProjectionMatrix(),m.lookAt(new THREE.Vector3(0,0,n)),n>i&&(u.remove(f[n-i]),E[n-i].dispose(),y[n-i].dispose(),v[n-i].dispose(),delete E[n-i],delete y[n-i],delete v[n-i]),n++,requestAnimationFrame(A)};window.addEventListener("load",async()=>{c.src=await S("./demo.flac"),document.getElementById("play").addEventListener("click",async()=>{o.state=="suspended"&&o.resume(),b(),c.play()}),document.getElementById("stop").addEventListener("click",()=>c.stop()),document.getElementById("file").addEventListener("dragover",e=>(e.stopPropagation(),e.preventDefault(),e.dataTransfer.dropEffect="copy",!1)),document.getElementById("file").addEventListener("drag",B,!1),document.getElementById("file").addEventListener("change",B,!1),document.getElementById("reverb").addEventListener("click",b),document.getElementById("reverse").addEventListener("click",e=>r.reverse(e.target.checked)),document.getElementById("time").addEventListener("change",e=>{r.time(e.target.value),e.target.title=e.target.value}),document.getElementById("decay").addEventListener("change",e=>{r.decay(e.target.value),e.target.title=e.target.value}),document.getElementById("delay").addEventListener("change",e=>{r.delay(e.target.value),e.target.title=e.target.value}),document.getElementById("filter").addEventListener("change",e=>{r.filterType(e.target.value),e.target.title=e.target.value}),document.getElementById("freq").addEventListener("change",e=>{r.filterFreq(e.target.value),e.target.title=e.target.value}),document.getElementById("q").addEventListener("change",e=>{r.filterQ(e.target.value),e.target.title=e.target.value}),document.getElementById("mix").addEventListener("change",e=>{r.mix(e.target.value),e.target.title=e.target.value}),document.querySelectorAll("[name=noise]").forEach(e=>e.addEventListener("click",t=>{document.getElementById("peaks").disabled=t.target.value==="white",r.setNoise(t.target.value)})),document.getElementById("peaks").addEventListener("change",e=>{r.peaks(e.target.value),e.target.title=e.target.value}),document.getElementById("scale").addEventListener("change",e=>{r.scale(e.target.value),e.target.title=e.target.value}),document.getElementById("randomAlgorithm").addEventListener("change",e=>{r.randomAlgorithm(e.target.value),e.target.title=e.target.value}),A()});
