/**
 * @logue/reverb
 *
 * @description JavaScript Reverb effect class
 * @author Logue <logue@hotmail.co.jp>
 * @copyright 2019-2022 By Masashi Yoshikawa All rights reserved.
 * @license MIT
 * @version 1.0.1
 * @see {@link https://github.com/logue/Reverb.js}
 */

(function(u,h){typeof exports=="object"&&typeof module<"u"?h(exports):typeof define=="function"&&define.amd?define(["exports"],h):(u=typeof globalThis<"u"?globalThis:u||self,h(u.Reverb={}))})(this,function(u){"use strict";const h={version:"1.0.1",date:"2022-09-04T03:08:47.653Z"},a={BLUE:"blue",GREEN:"green",PINK:"pink",RED:"red",VIOLET:"violet",WHITE:"white",BROWN:"red"},G=(t,e)=>t!=null&&typeof t[e]=="function",x=t=>G(t,"xform")?t.xform():t,F=t=>t!=null&&typeof t[Symbol.iterator]=="function";class f{constructor(e){this.value=e}deref(){return this.value}}const k=t=>new f(t),C=t=>t instanceof f,j=t=>t instanceof f?t:new f(t),w=t=>t instanceof f?t.deref():t,S=(t,e)=>[t,i=>i,e];function D(t){return t?[...t]:S(()=>[],(e,i)=>(e.push(i),e))}function*q(t,e){const i=x(t)(D()),s=i[1],o=i[2];for(let r of e){const n=o([],r);if(C(n)){yield*w(s(n.deref()));return}n.length&&(yield*n)}yield*w(s([]))}const B=(t,e)=>[t[0],t[1],e];function g(t,e){return F(e)?q(g(t),e):i=>{const s=i[2];let o=t;return B(i,(r,n)=>--o>0?s(r,n):o===0?j(s(r,n)):k(r))}}const E=1/2**32;class L{float(e=1){return this.int()*E*e}norm(e=1){return(this.int()*E-.5)*2*e}minmax(e,i){return this.float()*(i-e)+e}minmaxInt(e,i){return e|=0,i|=0,e+(this.float()*(i-e)|0)}}const b=Math.random;class M extends L{int(){return b()*4294967296>>>0}float(e=1){return b()*e}norm(e=1){return(b()-.5)*2*e}}const d=new M,v=(t,e,i)=>{const s=new Array(t);for(let o=0;o<t;o++)s[o]=i.norm(e);return s},y=t=>t.reduce((e,i)=>e+i,0);function*I(t,e){const i=[t[Symbol.iterator](),e[Symbol.iterator]()];for(let s=0;;s^=1){const o=i[s].next();if(o.done)return;yield o.value}}function*N(t=2,e=1,i=d){const s=v(t,e,i);s.forEach((n,l)=>s[l]=l&1?n:-n);const o=1/t;let r=y(s);for(let n=0,l=-1;;++n>=t&&(n=0))r-=s[n],r+=s[n]=l*i.norm(e),l^=4294967294,yield l*r*o}const A=(t=2,e=1,i=d)=>I(N(t,e,i),N(t,e,i)),O=t=>{let e=32;return t&=-t,t&&e--,t&65535&&(e-=16),t&16711935&&(e-=8),t&252645135&&(e-=4),t&858993459&&(e-=2),t&1431655765&&(e-=1),e};function*Q(t=8,e=1,i=d){const s=v(t,e,i),o=1/t;let r=y(s);for(let n=0;;n=n+1>>>0){const l=O(n)%t;r-=s[l],r+=s[l]=i.norm(e),yield r*o}}function*R(t=2,e=1,i=d){const s=v(t,e,i),o=1/t;let r=y(s);for(let n=0;;++n>=t&&(n=0))r-=s[n],r+=s[n]=i.norm(e),yield r*o}const W=(t=2,e=1,i=d)=>I(R(t,e,i),R(t,e,i));function*T(t=1,e=d){for(;;)yield e.norm(t)}class p{constructor(e,i){this.noise=T,this.ctx=e,this.options={...P,...i},this.wetGainNode=this.ctx.createGain(),this.dryGainNode=this.ctx.createGain(),this.filterNode=this.ctx.createBiquadFilter(),this.convolverNode=this.ctx.createConvolver(),this.outputNode=this.ctx.createGain(),this.isConnected=!1,this.setNoise(this.options.noise),this.buildImpulse(),this.mix(this.options.mix)}connect(e){return this.isConnected&&this.options.once?(this.isConnected=!1,this.outputNode):(this.convolverNode.connect(this.filterNode),this.filterNode.connect(this.wetGainNode),e.connect(this.convolverNode),e.connect(this.dryGainNode).connect(this.outputNode),e.connect(this.wetGainNode).connect(this.outputNode),this.isConnected=!0,this.outputNode)}disconnect(e){return this.isConnected&&(this.convolverNode.disconnect(this.filterNode),this.filterNode.disconnect(this.wetGainNode)),this.isConnected=!1,e}mix(e){if(!this.inRange(e,0,1))throw new RangeError("[Reverb.js] Dry/Wet ratio must be between 0 to 1.");this.options.mix=e,this.dryGainNode.gain.value=1-this.options.mix,this.wetGainNode.gain.value=this.options.mix}time(e){if(!this.inRange(e,1,50))throw new RangeError("[Reverb.js] Time length of inpulse response must be less than 50sec.");this.options.time=e,this.buildImpulse()}decay(e){if(!this.inRange(e,0,100))throw new RangeError("[Reverb.js] Inpulse Response decay level must be less than 100.");this.options.decay=e,this.buildImpulse()}delay(e){if(!this.inRange(e,0,100))throw new RangeError("[Reverb.js] Inpulse Response delay time must be less than 100.");this.options.delay=e,this.buildImpulse()}reverse(e){this.options.reverse=e,this.buildImpulse()}filterType(e){this.filterNode.type=this.options.filterType=e}filterFreq(e){if(!this.inRange(e,20,2e4))throw new RangeError("[Reverb.js] Filter frequrncy must be between 20 and 20000.");this.options.filterFreq=e,this.filterNode.frequency.value=this.options.filterFreq}filterQ(e){if(!this.inRange(e,0,10))throw new RangeError("[Reverb.js] Filter quality value must be between 0 and 10.");this.options.filterQ=e,this.filterNode.Q.value=this.options.filterQ}power(e){this.options.power=e,this.buildImpulse()}setNoise(e){switch(this.options.noise=e,e){case a.BLUE:this.noise=N;break;case a.GREEN:this.noise=A;break;case a.PINK:this.noise=Q;break;case a.RED:case a.BROWN:this.noise=R;break;case a.VIOLET:this.noise=W;break;default:this.noise=T;break}this.buildImpulse()}inRange(e,i,s){return(e-i)*(e-s)<=0}buildImpulse(){const e=this.ctx.sampleRate,i=Math.max(e*this.options.time,1),s=e*this.options.delay,o=this.ctx.createBuffer(2,i,e),r=new Float32Array(i),n=new Float32Array(i),l=this.getNoise(i),V=this.getNoise(i);for(let c=0;c<i;c++){let m=0;c<s?(r[c]=0,n[c]=0,m=this.options.reverse?i-(c-s):c-s):m=this.options.reverse?i-c:c,r[c]=l[c]*(1-m/i)**this.options.decay,n[c]=V[c]*(1-m/i)**this.options.decay}o.getChannelData(0).set(r),o.getChannelData(1).set(n),this.convolverNode.buffer=o}getNoise(e){return[...g(e,this.noise())].map(i=>i*this.options.power)}}p.version=h.version,p.build=h.date;const P={noise:a.WHITE,power:2,decay:2,delay:0,reverse:!1,time:2,filterType:"lowpass",filterFreq:2200,filterQ:1,mix:.5,once:!1};window.Reverb||(window.Reverb=p),u.Noise=a,u.default=p,Object.defineProperties(u,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});
